name: release

on:
  push:
    tags:
    - "v*"

jobs:
  release-nhctl:
    name: Release nhctl
    runs-on: ubuntu-latest
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ^1.14

    - name: Checkout nocalhost
      uses: actions/checkout@v2.3.4
      with:
        repository: nocalhost/nocalhost
        ref: feature/actions/syncthing

    - name: Get tag
      run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

    - name: Get commit id
      run: echo "NH_COMMIT_ID=$(git describe --match=NeVeRmAtCh --always --abbrev=40 --dirty)" >> $GITHUB_ENV

    - name: Checkout syncthing
      uses: actions/checkout@v2.3.4
      with:
        repository: nocalhost/syncthing
        path: ./syncthing-source
        ref: nh-release

    - name: Build syncthing
      working-directory: ./syncthing-source
      run: ./build.sh artifact all ${{ env.RELEASE_VERSION }} ${{ env.NH_COMMIT_ID }}

    - name: Push to Coding Articact
      working-directory: ./syncthing-source
      env:
        VERSION: ${{ env.RELEASE_VERSION }}
      run: |
        curl -T syncthing-linux-amd64.tar.gz -u ${{ secrets.CODING_ARTIFACTS_USER }}:${{ secrets.CODING_ARTIFACTS_PASS }} "https://codingcorp-generic.pkg.coding.net/nocalhost/syncthing/syncthing-linux-amd64.tar.gz?version=${VERSION}"
        curl -T syncthing-linux-arm64.tar.gz -u ${{ secrets.CODING_ARTIFACTS_USER }}:${{ secrets.CODING_ARTIFACTS_PASS }} "https://codingcorp-generic.pkg.coding.net/nocalhost/syncthing/syncthing-linux-arm64.tar.gz?version=${VERSION}"
        curl -T syncthing-macos-amd64.zip -u ${{ secrets.CODING_ARTIFACTS_USER }}:${{ secrets.CODING_ARTIFACTS_PASS }} "https://codingcorp-generic.pkg.coding.net/nocalhost/syncthing/syncthing-macos-amd64.zip?version=${VERSION}"
        curl -T syncthing-windows-amd64.zip -u ${{ secrets.CODING_ARTIFACTS_USER }}:${{ secrets.CODING_ARTIFACTS_PASS }} "https://codingcorp-generic.pkg.coding.net/nocalhost/syncthing/syncthing-windows-amd64.zip?version=${VERSION}"

  build-syncthing-windows:
    name: Build syncthing windows
    runs-on: windows-latest
    steps:

      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.15.6

      - name: Get tag
        run: |
         $branchName = "${{github.ref}}".Split("/")["${{github.ref}}".Split("/").Length -1]
         echo "::set-env name=RELEASE_VERSION::$(echo $branchName)"
         echo "RELEASE_VERSION=$branchName" >> $GITHUB_ENV
         echo "${RELEASE_VERSION}"

      - name: Checkout syncthing
        uses: actions/checkout@v2.3.4
        with:
          repository: nocalhost/syncthing
          path: ./syncthing-source
          ref: main

      - name: Build syncthing
        working-directory: ./syncthing-source
        run: |
          go run build.go -targetName=syncthing -cmd=zip -nocalhostVersion="${RELEASE_VERSION}" -nocalhostCommitId="${GITHUB_SHA}"

      - name: Push to Coding Articact
        working-directory: ./syncthing-source
        run: |
          curl -T syncthing-windows-amd64.zip -u ${{ secrets.CODING_ARTIFACTS_USER }}:${{ secrets.CODING_ARTIFACTS_PASS }} "https://codingcorp-generic.pkg.coding.net/nocalhost/syncthing/syncthing-windows-amd64.zip?version=${RELEASE_VERSION}"
